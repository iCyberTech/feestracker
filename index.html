<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Financial Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        /* [Previous CSS styles remain exactly the same] */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .summary-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        /* [Rest of CSS remains unchanged] */
    </style>
</head>
<body>
    <!-- [Previous HTML content remains exactly the same until the scripts] -->

    <!-- Firebase and other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAtELW6wBsFVMYBOyNd8UgO5YxSjMk0VCI",
            authDomain: "fees-tracker-hwe.firebaseapp.com",
            databaseURL: "https://fees-tracker-hwe-default-rtdb.firebaseio.com",
            projectId: "fees-tracker-hwe",
            storageBucket: "fees-tracker-hwe.appspot.com",
            messagingSenderId: "743578133528",
            appId: "1:743578133528:web:fc800970e075c4b4be0f6d",
            measurementId: "G-K0PYH1G62H"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Debugging: Log Firebase initialization
        console.log("Firebase initialized:", app);
        console.log("Database reference:", database);

        // DOM Elements
        const addFeeBtn = document.getElementById('add-fee');
        const addOfferingBtn = document.getElementById('add-offering');
        const addFoodBtn = document.getElementById('add-food');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw');
        const totalBalanceElement = document.getElementById('total-balance');
        const totalIncomeElement = document.getElementById('total-income');
        const totalWithdrawalsElement = document.getElementById('total-withdrawals');
        const currentBalanceDisplay = document.getElementById('current-balance-display');
        const testBtn = document.getElementById('test-btn');

        // Initialize DataTables
        $(document).ready(function() {
            $('#fees-table').DataTable();
            $('#offerings-table').DataTable();
            $('#food-table').DataTable();
            $('#withdrawals-table').DataTable();
        });

        // Global variables to store totals
        let totalIncome = 0;
        let totalWithdrawals = 0;
        let currentBalance = 0;

        // Function to format date
        function formatDate(timestamp) {
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return "Invalid Date";
                }
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('en-US', options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return "Date Error";
            }
        }

        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GH', { style: 'currency', currency: 'GHS' }).format(amount);
        }

        // Function to update totals display
        function updateTotalsDisplay() {
            totalIncomeElement.textContent = formatCurrency(totalIncome);
            totalWithdrawalsElement.textContent = formatCurrency(totalWithdrawals);
            totalBalanceElement.textContent = formatCurrency(currentBalance);
            currentBalanceDisplay.textContent = formatCurrency(currentBalance);
        }

        // Function to calculate totals from database
        function calculateTotals() {
            console.log("Calculating totals...");
            totalIncome = 0;
            totalWithdrawals = 0;
            
            // Calculate income from class fees
            const classFeesRef = database.ref('classFees');
            classFeesRef.once('value', (snapshot) => {
                console.log("Class fees snapshot:", snapshot.val());
                snapshot.forEach((childSnapshot) => {
                    const amount = parseFloat(childSnapshot.val().amount);
                    if (!isNaN(amount)) {
                        totalIncome += amount;
                    }
                });
                
                // Calculate income from offerings
                const offeringsRef = database.ref('offerings');
                offeringsRef.once('value', (snapshot) => {
                    console.log("Offerings snapshot:", snapshot.val());
                    snapshot.forEach((childSnapshot) => {
                        const amount = parseFloat(childSnapshot.val().amount);
                        if (!isNaN(amount)) {
                            totalIncome += amount;
                        }
                    });
                    
                    // Calculate income from food vendors
                    const foodRef = database.ref('foodVendors');
                    foodRef.once('value', (snapshot) => {
                        console.log("Food vendors snapshot:", snapshot.val());
                        snapshot.forEach((childSnapshot) => {
                            const amount = parseFloat(childSnapshot.val().amount);
                            if (!isNaN(amount)) {
                                totalIncome += amount;
                            }
                        });
                        
                        // Calculate total withdrawals
                        const withdrawalsRef = database.ref('withdrawals');
                        withdrawalsRef.once('value', (snapshot) => {
                            console.log("Withdrawals snapshot:", snapshot.val());
                            snapshot.forEach((childSnapshot) => {
                                const amount = parseFloat(childSnapshot.val().amount);
                                if (!isNaN(amount)) {
                                    totalWithdrawals += amount;
                                }
                            });
                            
                            // Calculate current balance
                            currentBalance = totalIncome - totalWithdrawals;
                            
                            // Update display
                            updateTotalsDisplay();
                            console.log("Totals calculated - Income:", totalIncome, "Withdrawals:", totalWithdrawals, "Balance:", currentBalance);
                        }).catch((error) => {
                            console.error("Error getting withdrawals:", error);
                        });
                    }).catch((error) => {
                        console.error("Error getting food vendors:", error);
                    });
                }).catch((error) => {
                    console.error("Error getting offerings:", error);
                });
            }).catch((error) => {
                console.error("Error getting class fees:", error);
            });
        }

        // Load and display class fees
        function loadClassFees() {
            console.log("Loading class fees...");
            const feesTableBody = document.querySelector('#fees-table tbody');
            const classFeesRef = database.ref('classFees').orderByChild('date');
            
            classFeesRef.on('value', (snapshot) => {
                console.log("Class fees data received:", snapshot.val());
                feesTableBody.innerHTML = '';
                const fees = [];
                
                snapshot.forEach((childSnapshot) => {
                    const fee = childSnapshot.val();
                    fee.id = childSnapshot.key;
                    fees.unshift(fee); // Add to beginning to show newest first
                });
                
                fees.forEach((fee) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${formatDate(fee.date)}</td>
                        <td>${fee.className || 'N/A'}</td>
                        <td>${formatCurrency(fee.amount || 0)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-fee" data-id="${fee.id}">Delete</button>
                        </td>
                    `;
                    
                    feesTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-fee').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const feeId = e.target.getAttribute('data-id');
                        deleteClassFee(feeId);
                    });
                });
                
                $('#fees-table').DataTable().draw();
            }, (error) => {
                console.error("Error loading class fees:", error);
            });
        }

        // Add new class fee
        addFeeBtn.addEventListener('click', () => {
            const classSelect = document.getElementById('class-select');
            const feeAmount = document.getElementById('fee-amount');
            
            if (!feeAmount.value || isNaN(feeAmount.value) || parseFloat(feeAmount.value) <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const newFee = {
                className: classSelect.value,
                amount: parseFloat(feeAmount.value),
                date: Date.now()
            };
            
            console.log("Adding class fee:", newFee);
            database.ref('classFees').push(newFee)
                .then(() => {
                    console.log("Class fee added successfully");
                    feeAmount.value = '';
                    calculateTotals();
                    alert('Class fee added successfully!');
                })
                .catch((error) => {
                    console.error('Error adding fee:', error);
                    alert('Error adding fee. Please check console for details.');
                });
        });

        // [Rest of the JavaScript functions remain the same as previous Realtime Database implementation]
        // Only changed the initialization and added more debugging

        // Test Database connection
        testBtn.addEventListener('click', () => {
            console.log("Testing database connection...");
            const testRef = database.ref('testConnection');
            const testData = {
                test: true,
                timestamp: Date.now(),
                message: "This is a test connection"
            };
            
            testRef.push(testData)
                .then((ref) => {
                    console.log("Test data written with key:", ref.key);
                    alert('Database connection successful! Data written with key: ' + ref.key);
                    // Clean up test data
                    return testRef.child(ref.key).remove();
                })
                .then(() => {
                    console.log("Test data cleaned up");
                })
                .catch((error) => {
                    console.error("Database connection failed:", error);
                    alert("Failed to connect to database. Check console for details. Error: " + error.message);
                });
        });

        // Initialize the application
        function initApp() {
            console.log("Initializing application...");
            loadClassFees();
            loadOfferings();
            loadFoodVendors();
            loadWithdrawals();
            calculateTotals();
            
            // Update current balance in withdrawal modal when it opens
            document.getElementById('withdrawModal').addEventListener('show.bs.modal', function () {
                document.getElementById('current-balance-display').textContent = formatCurrency(currentBalance);
            });

            console.log("Application initialized");
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
